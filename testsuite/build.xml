<project name="sitemesh-testsuite" default="tests-build" basedir=".">

	<property name="test-results" value="test-results"/>

	<path id="classpath">
		<fileset dir="lib" />
		<fileset dir="../lib" />
		<fileset dir="../dist" />
	</path>

	<target name="sitemesh-build" description="Build SiteMesh jar">
		<ant dir=".." target="jar" />
	</target>

	<target name="webapp-build" depends="sitemesh-build,tests-build" description="Build web-app .war file">
		<mkdir dir="tmp/webapp/WEB-INF/classes" />
		<!--<javac srcdir="webapp/WEB-INF/classes" destdir="tmp/webapp/WEB-INF/classes" classpathref="classpath" />-->
		<javac srcdir="src/java" destdir="tmp/webapp/WEB-INF/classes" classpathref="classpath" includes="testsuite/i18n/EncodingFilter.java" debug="on"/>
		<mkdir dir="dist" />
		<war destfile="dist/sitemesh-testsuite.war" webxml="src/webapp/WEB-INF/web.xml">
      <lib dir="../dist">
        <include name="sitemesh-2.0.jar" />
        <include name="*.tld"/>
      </lib>
      <classes dir="tmp/webapp/WEB-INF/classes" />
      <webinf dir="src/webapp/WEB-INF/">
        <include name="*.xml" />
        <exclude name="web.xml"/>
      </webinf>
      <fileset dir="src/webapp">
        <exclude name="WEB-INF/**" />
      </fileset>
		</war>
	</target>

	<target name="dist" depends="webapp-build"/>

	<target name="tests-build" depends="sitemesh-build" description="Build test suite">
		<mkdir dir="tmp/tests" />
		<javac srcdir="src/java" destdir="tmp/tests" classpathref="classpath" debug="on" />
		<mkdir dir="dist" />
		<jar jarfile="dist/sitemesh-testsuite.jar">
			<fileset dir="tmp/tests" />
		</jar>
	</target>

	<target name="deploy" depends="tests-build, webapp-build" description="Deploy web-app to servers">
		<java classname="testsuite.deploy.DeployWebApps" classpathref="classpath" fork="yes" dir=".">
			<classpath>
				<fileset dir="dist" />
			</classpath>
		</java>
	</target>

	<target name="test" depends="test-standalone, test-container" description="Run standalone and in-container tests"/>

	<target name="test-standalone" depends="tests-build" description="Run standalone unit tests">
		<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" classpathref="classpath" />
		<mkdir dir="${test-results}" />
		<echo message="Running standalone unit tests..."/>
		<junit fork="no" haltonfailure="yes">
			<classpath>
				<fileset dir="lib" />
				<fileset dir="dist" />
				<fileset dir="../lib" />
				<fileset dir="../dist" />
			</classpath>
			<formatter type="plain" usefile="false"/>
			<formatter type="xml"/>
			<test todir="${test-results}" name="testsuite.unittests.HTMLPageParserTestSuite" />
		</junit>
	</target>

	<target name="test-container" depends="tests-build" description="Run unit tests on deployed web-app">
		<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" classpathref="classpath" />
		<mkdir dir="${test-results}" />
		<echo message="Running in-container unit tests..."/>
		<junit fork="no" haltonfailure="no">
			<classpath>
				<fileset dir="lib" />
				<fileset dir="dist" />
				<fileset dir="../lib" />
				<fileset dir="../dist" />
			</classpath>
			<formatter type="plain" usefile="false"/>
			<formatter type="xml"/>
			<test todir="${test-results}" name="testsuite.sitemesh.SiteMeshTestSuite" />
		</junit>
	</target>

	<target name="report">
        <junitreport todir="${test-results}">
            <fileset dir="${test-results}">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="frames" todir="${test-results}"/>
        </junitreport>
    </target>

	<target name="clean" description="Clean up all built files">
        <ant dir=".." target="clean" />
		<delete dir="tmp" />
		<delete dir="dist" />
		<delete dir="${test-results}" />
	</target>

</project>
